name: build container image
on:
  push:
    branches:
      - main

jobs:
  docker:
    env:
      PLATFORMS: linux/amd64
    if: github.event.pull_request.draft == false
    name: ${{ matrix.gpu-driver }}
    runs-on: ubuntu-latest
    steps:
      - name: Start Energy Measurement
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          task: start-measurement
      - name: Free up more disk space on the runner
        run: 'echo "----- Free space before cleanup"

          df -h

          sudo rm -rf /usr/share/dotnet

          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

          sudo swapoff /mnt/swapfile

          sudo rm -rf /mnt/swapfile

          echo "----- Free space after cleanup"

          df -h

          '
      - id: measurement-2
        name: Record Measurement After Free up more disk space on the runner
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          label: Free up more disk space on the runner
          task: get-measurement
      - name: Checkout
        uses: actions/checkout@v4
      - id: meta
        name: Docker meta
        uses: docker/metadata-action@v5
        with:
          flavor:
            "latest=${{ matrix.gpu-driver == 'cuda' && github.ref == 'refs/heads/main'}}

            suffix=-${{ matrix.gpu-driver }},onlatest=false

            "
          github-token: ${{ secrets.GITHUB_TOKEN }}
          images: 'ghcr.io/${{ github.repository }}

            '
          tags: 'type=ref,event=branch

            type=ref,event=tag

            type=pep440,pattern={{version}}

            type=pep440,pattern={{major}}.{{minor}}

            type=pep440,pattern={{major}}

            type=sha,enable=true,prefix=sha-,format=short

            '
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ env.PLATFORMS }}
      - if: github.event_name != 'pull_request'
        name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ghcr.io
          username: ${{ github.repository_owner }}
      - id: docker_build
        name: Build container
        timeout-minutes: 40
        uses: docker/build-push-action@v6
        with:
          build-args: 'GPU_DRIVER=${{ matrix.gpu-driver }}

            '
          context: .
          file: docker/Dockerfile
          labels: ${{ steps.meta.outputs.labels }}
          platforms: ${{ env.PLATFORMS }}
          push:
            ${{ github.ref == 'refs/heads/main' || github.ref_type == 'tag' ||
            github.event.inputs.push-to-registry }}
          tags: ${{ steps.meta.outputs.tags }}
      - id: display-measurement
        name: Display Energy Results
        uses: green-coding-solutions/eco-ci-energy-estimation@862050e4f01f65b1436e5eca18ba4bd85562f0de
        with:
          json-output: true
          task: display-results
      - name: Save Total Energy Consumption Data
        run: echo '${{ steps.final-measurement.outputs.data-total-json }}' > total_energy_consumption.json
      - name: Upload Energy Consumption Artifact
        uses: actions/upload-artifact@v4
        with:
          name: total-energy-consumption
          path: total_energy_consumption.json
    strategy:
      fail-fast: false
      matrix:
        gpu-driver:
          - cuda
          - cpu
          - rocm
permissions:
  contents: write
  packages: write
